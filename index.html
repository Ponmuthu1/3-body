<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Atom Simulator</title>
    <style>
        html, body { margin: 0; padding: 0; overflow: hidden; height: 100%; }
        #glowscript-canvas { width: 100vw; height: 100vh; display: block; }
    </style>
    <link type="text/css" href="https://www.glowscript.org/css/redmond/2.1/jquery-ui.custom.css" rel="stylesheet" />
    <link type="text/css" href="https://www.glowscript.org/css/ide.css" rel="stylesheet" />
    <script type="text/javascript" src="https://www.glowscript.org/lib/jquery/2.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://www.glowscript.org/lib/jquery/2.1/jquery-ui.custom.min.js"></script>
    <script type="text/javascript" src="https://www.glowscript.org/package/glow.3.2.min.js"></script>
    <script type="text/javascript" src="https://www.glowscript.org/package/RSrun.3.2.min.js"></script>
</head>
<body>
    <div id="glowscript" class="glowscript"></div>
    <script type="text/javascript">
        ;(function() {
            var ρσ_modules = {};
            var follow_index;
            ρσ_modules.pythonize = {};

            (function(){
                function strings() {
                    var string_funcs, exclude, name;
                    string_funcs = new Set("capitalize strip lstrip rstrip islower isupper isspace lower upper swapcase center count endswith startswith find rfind index rindex format join ljust rjust partition rpartition replace split rsplit splitlines zfill".split(" "));
                    if (!arguments.length) {
                        exclude = new Set(["split", "replace"]);
                    } else if (arguments[0]) {
                        exclude = new Set(Array.prototype.slice.call(arguments));
                    } else {
                        exclude = null;
                    }
                    if (exclude) {
                        string_funcs = new Set([...string_funcs].filter(x => !exclude.has(x)));
                    }
                    for (let name of string_funcs) {
                        String.prototype[name] = String.prototype[name] || ρσ_str.prototype[name];
                    }
                }
                if (!strings.__module__) Object.defineProperties(strings, {
                    __module__ : {value: "pythonize"}
                });

                ρσ_modules.pythonize.strings = strings;
            })();

            async function __main__() {
                "use strict";
                var display = canvas;
                var scene = canvas();

                function round(num, n=0) {return Number(num.toFixed(n))}

                var fullscreen_js, G, m1, m2, m3, r1, r2, r3, v1, v2, v3, sun1, sun2, planet, dt, follow_index, objects_to_follow, F12, F13, F23;
                fullscreen_js = `
                <style>
                html, body { margin: 0; padding: 0; overflow: hidden; height: 100%; }
                #glowscript-canvas { width: 100vw; height: 100vh; display: block; }
                </style>
                <script>
                window.addEventListener("load", function() {
                    var canvas = document.getElementById('glowscript-canvas');
                    if (canvas.requestFullscreen) {
                        canvas.requestFullscreen();
                    } else if (canvas.mozRequestFullScreen) { // Firefox
                        canvas.mozRequestFullScreen();
                    } else if (canvas.webkitRequestFullscreen) { // Chrome, Safari and Opera
                        canvas.webkitRequestFullscreen();
                    } else if (canvas.msRequestFullscreen) { // IE/Edge
                        canvas.msRequestFullscreen();
                    }
                });
                </script>
                `;
                scene.append_to_caption(fullscreen_js);
                scene.width = 1920;
                scene.height = 1080;
                scene.background = color.black;

                G = 6.6743e-11;
                m1 = 1.989e30;
                m2 = 1.989e30;
                m3 = 5.972e24;

                r1 = vector(-1e11, 0, 0);
                r2 = vector(1e11, 0, 0);
                r3 = vector(0, 0, 0);

                v1 = vector(0, -2e4, 0);
                v2 = vector(0, 2e4, 0);
                v3 = vector(2.5e4, 0, 0);

                sun1 = sphere({pos: r1, radius: 7e9, texture: "sun_texture.jpg", emissive: true});
                sun2 = sphere({pos: r2, radius: 7e9, texture: "sun_texture.jpg", emissive: true});
                planet = sphere({pos: r3, radius: 3e9, texture: "earth_texture.jpg", make_trail: true, trail_color: color.white});

                distant_light({direction: vector(1, 0, 0), color: color.white});
                local_light({pos: sun1.pos, color: color.yellow});
                local_light({pos: sun2.pos, color: color.orange});

                dt = 1000;

                async function gravitational_force(m1, m2, r1, r2) {
                    var r, r_mag, r_hat, force;
                    r = r2.sub(r1);
                    r_mag = mag(r);
                    r_hat = r.div(r_mag);
                    force = G * m1 * m2 / Math.pow(r_mag, 2) * r_hat;
                    return force;
                }

                scene.camera.pos = vector(0, -2e11, 2e11);
                scene.camera.axis = vector(0, -1e11, -2e11);

                follow_index = 0;
                objects_to_follow = [planet, sun1, sun2];

                function on_keydown(evt) {
                    if (evt.key === 'f') {
                        follow_index = (follow_index + 1) % objects_to_follow.length;
                        scene.camera.follow(objects_to_follow[follow_index]);
                    }
                }

                scene.bind("keydown", on_keydown);

                while (true) {
                    await rate(100);

                    F12 = await gravitational_force(m1, m2, r1, r2);
                    F13 = await gravitational_force(m1, m3, r1, r3);
                    F23 = await gravitational_force(m2, m3, r2, r3);

                    v1 = v1.add(F12.add(F13).div(m1).mul(dt));
                    v2 = v2.add(F12.neg().add(F23).div(m2).mul(dt));
                    v3 = v3.add(F13.neg().sub(F23).div(m3).mul(dt));

                    r1 = r1.add(v1.mul(dt));
                    r2 = r2.add(v2.mul(dt));
                    r3 = r3.add(v3.mul(dt));

                    sun1.pos = r1;
                    sun2.pos = r2;
                    planet.pos = r3;

                    scene.center = objects_to_follow[follow_index].pos;
                }
            }
            $(function(){ window.__context = { glowscript_container: $("#glowscript").removeAttr("id") }; __main__() });
        })();
    </script>
</body>
</html>
